<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morse</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --main-bg: #121212; --panel-bg: #1e1e1e; --point-color: #00ff66; --warn-color: #ffcc00; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--main-bg); color: #e0e0e0; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { width: 120px; background: var(--panel-bg); border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .t-header { padding: 12px; background: #252525; color: var(--point-color); font-weight: bold; font-size: 12px; text-align: center; border-bottom: 1px solid #333; }
        #tutorial-list { flex: 1; overflow-y: auto; padding: 8px; font-size: 11px; }
        .t-item { display: flex; justify-content: space-between; margin-bottom: 4px; color: #aaa; border-bottom: 1px solid #2a2a2a; }

        #main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        #header { padding: 8px 15px; background: var(--panel-bg); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #333; }
        .info-bar { display: flex; align-items: center; gap: 10px; font-size: 13px; }
        input { background: #333; color: var(--point-color); border: 1px solid #444; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        
        #display { flex: 1; padding: 20px; overflow-y: auto; background: #0a0a0a; display: flex; flex-direction: column; gap: 10px; }
        .msg-bubble { padding: 10px 14px; border-radius: 12px; max-width: 75%; font-size: 15px; line-height: 1.4; position: relative; }
        .msg-remote { background: #2a2a2a; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-me { background: #004d2c; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-deleted { display: none !important; } /* 삭제된 메시지 완전 숨김 */
        .sender-tag { font-size: 10px; color: #888; margin-bottom: 4px; display: block; }

        #work-area { background: #1a1a1a; border-top: 1px solid #333; padding: 10px 15px; }
        #writing-zone { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        #local-text { color: var(--point-color); font-size: 1.3rem; font-weight: bold; min-height: 1.5rem; }
        #preview-char { color: var(--warn-color); font-size: 1.4rem; font-weight: bold; background: #333; padding: 0 10px; border-radius: 4px; min-width: 24px; text-align: center; }
        #current-morse { height: 25px; color: #666; font-size: 1rem; letter-spacing: 3px; }

        #controls { height: 40vh; background: #000; display: grid; grid-template-areas: 
            "next space"
            "dot dash"
            "send send";
            grid-template-rows: 1fr 2fr 1fr;
            grid-template-columns: 1fr 1fr;
            gap: 4px; padding: 4px;
        }
        .btn { display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; user-select: none; border-radius: 4px; -webkit-tap-highlight-color: transparent; }
        .btn:active { filter: brightness(1.3); transform: scale(0.98); }
        
        #next-char-btn { grid-area: next; background: #333; color: #eee; }
        #space-btn { grid-area: space; background: #333; color: #eee; }
        #dot-btn { grid-area: dot; background: #444; color: #fff; font-size: 2rem; }
        #dash-btn { grid-area: dash; background: #444; color: #fff; font-size: 2rem; }
        #send-btn { grid-area: send; background: var(--point-color); color: #000; font-size: 1.3rem; }

        #status-info { font-size: 10px; color: #555; padding: 4px 15px; background: #000; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="t-header">MORSE GUIDE</div>
    <div id="tutorial-list"></div>
</div>

<div id="main">
    <div id="header">
        <div class="info-bar">
            <span>FREQ: <input type="text" id="freq" value="144.50" style="width:60px"></span>
            <span id="online-count" style="color:var(--point-color)">1 Online</span>
        </div>
        <div class="info-bar">
            ID: <input type="text" id="uuid-input" style="width:80px">
            <button onclick="if(confirm('Clear?')) document.getElementById('display').innerHTML=''" style="background:#222; color:#888; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">CLEAR</button>
        </div>
    </div>

    <div id="display"></div>
    
    <div id="work-area">
        <div id="writing-zone">
            <span id="local-text"></span>
            <span id="preview-char"></span>
        </div>
        <div id="current-morse"></div>
    </div>

    <div id="controls">
        <div id="next-char-btn" class="btn">NEXT CHAR</div>
        <div id="space-btn" class="btn">SPACE</div>
        <div id="dot-btn" class="btn">● (DOT)</div>
        <div id="dash-btn" class="btn">━ (DASH)</div>
        <div id="send-btn" class="btn">SEND MESSAGE</div>
    </div>
    
    <div id="status-info">
        <span id="conn-status">● OFFLINE</span>
        <span>BACKSPACE: ........ | DELCHAT: --------</span>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://morsecodeconnection-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = localStorage.getItem('morse_uuid') || "user-" + Math.random().toString(36).substring(2, 7).toUpperCase();
    document.getElementById('uuid-input').value = myId;
    document.getElementById('uuid-input').onchange = (e) => {
        myId = e.target.value.trim() || myId;
        localStorage.setItem('morse_uuid', myId);
    };

    const morseDict = { "A": ".-", "B": "-...", "C": "-.-.", "D": "-..", "E": ".", "F": "..-.", "G": "--.", "H": "....", "I": "..", "J": ".---", "K": "-.-", "L": ".-..", "M": "--", "N": "-.", "O": "---", "P": ".--.", "Q": "--.-", "R": ".-.", "S": "...", "T": "-", "U": "..-", "V": "...-", "W": ".--", "X": "-..-", "Y": "-.--", "Z": "--..", "1": ".----", "2": "..---", "3": "...--", "4": "....-", "5": ".....", "6": "-....", "7": "--...", "8": "---..", "9": "----.", "0": "-----" };
    const reverseMorse = {};
    Object.keys(morseDict).sort().forEach(char => {
        reverseMorse[morseDict[char]] = char;
        document.getElementById('tutorial-list').innerHTML += `<div class="t-item"><span>${char}</span><span>${morseDict[char]}</span></div>`;
    });

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(dur, freq = 750) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.value = freq;
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur/1000);
        setTimeout(() => osc.stop(), dur + 50);
    }

    let currentMorse = "";
    let localDraft = "";
    let currentFreqKey = "";
    let lastSentKey = null;

    function handleInput(sym) {
        currentMorse += sym;
        document.getElementById('current-morse').innerText = currentMorse;
        
        // 1. BACKSPACE (........) : 로컬 글자 지우기
        if (currentMorse === "........") {
            localDraft = localDraft.slice(0, -1);
            currentMorse = "";
            document.getElementById('current-morse').innerText = "";
            document.getElementById('preview-char').innerText = "BACKSPACE";
            setTimeout(() => { document.getElementById('preview-char').innerText = ""; }, 500);
            updateLocalView();
            beep(100, 200);
            return;
        }

        // 2. DELCHAT (--------) : 보낸 메시지 지우기
        if (currentMorse === "--------") {
            deleteLastSent();
            currentMorse = "";
            document.getElementById('current-morse').innerText = "";
            document.getElementById('preview-char').innerText = "DELCHAT";
            setTimeout(() => { document.getElementById('preview-char').innerText = ""; }, 500);
            beep(100, 150);
            return;
        }

        document.getElementById('preview-char').innerText = reverseMorse[currentMorse] || "?";
        beep(sym === '.' ? 100 : 300);
    }

    function deleteLastSent() {
        if (!lastSentKey) return;
        db.ref(`channels/${currentFreqKey}/messages/${lastSentKey}`).update({ deleted: true });
    }

    function nextChar() {
        if (!currentMorse) return;
        localDraft += (reverseMorse[currentMorse] || "?");
        currentMorse = "";
        document.getElementById('current-morse').innerText = "";
        document.getElementById('preview-char').innerText = "";
        updateLocalView();
        beep(50, 1000);
    }

    function addSpace() {
        localDraft += " ";
        updateLocalView();
        beep(50, 400);
    }

    function updateLocalView() {
        document.getElementById('local-text').innerText = localDraft;
    }

    function finalizeSend() {
        if (currentMorse) nextChar();
        const msg = localDraft.trim();
        if (!msg) return;

        const newRef = db.ref(`channels/${currentFreqKey}/messages`).push();
        lastSentKey = newRef.key;
        // DB에 deleted 태그를 기본적으로 추가
        newRef.set({
            sender: myId, 
            text: msg, 
            timestamp: firebase.database.ServerValue.TIMESTAMP, 
            deleted: false 
        });

        localDraft = "";
        updateLocalView();
        beep(150, 600);
    }

    function connectChannel() {
        let val = parseFloat(document.getElementById('freq').value);
        if (isNaN(val)) val = 144.50;
        const formattedFreq = val.toFixed(2);
        document.getElementById('freq').value = formattedFreq;
        
        if(currentFreqKey) {
            db.ref(`channels/${currentFreqKey}/messages`).off();
            db.ref(`channels/${currentFreqKey}/users`).off();
        }

        currentFreqKey = formattedFreq.replace('.', '_');
        document.getElementById('display').innerHTML = "";

        const msgRef = db.ref(`channels/${currentFreqKey}/messages`);
        
        msgRef.limitToLast(30).on('child_added', (snap) => {
            renderMessage(snap);
        });

        msgRef.on('child_changed', (snap) => {
            const el = document.getElementById("msg-" + snap.key);
            if (el && snap.val().deleted) el.classList.add('msg-deleted');
        });

        const pRef = db.ref(`channels/${currentFreqKey}/users`).push(myId);
        pRef.onDisconnect().remove();
        db.ref(`channels/${currentFreqKey}/users`).on('value', (snap) => {
            document.getElementById('online-count').innerText = `${snap.numChildren()} Online`;
        });
    }

    function renderMessage(snap) {
        const data = snap.val();
        const d = document.getElementById('display');
        const isMe = data.sender === myId;
        const msgDiv = document.createElement('div');
        msgDiv.id = "msg-" + snap.key;
        msgDiv.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-remote'} ${data.deleted ? 'msg-deleted' : ''}`;
        msgDiv.innerHTML = `<span class="sender-tag">${isMe ? '나' : data.sender}</span>${data.text}`;
        d.appendChild(msgDiv);
        d.scrollTop = d.scrollHeight;
        if (!isMe && Date.now() - data.timestamp < 2000) beep(200);
    }

    document.getElementById('freq').onchange = connectChannel;
    const bind = (id, fn) => {
        document.getElementById(id).addEventListener('pointerdown', (e) => { e.preventDefault(); fn(); });
    };
    bind('dot-btn', () => handleInput('.'));
    bind('dash-btn', () => handleInput('-'));
    bind('next-char-btn', nextChar);
    bind('space-btn', addSpace);
    bind('send-btn', finalizeSend);

    db.ref(".info/connected").on("value", (snap) => {
        const s = document.getElementById('conn-status');
        s.innerText = snap.val() ? "● ONLINE" : "● OFFLINE";
        s.style.color = snap.val() ? "#00ff00" : "#ff4444";
        if(snap.val()) connectChannel();
    });
</script>
</body>
</html>
